/**
 * Automatically attach featured images to pages only
 * so they don't appear as "unattached" in the media library.
 * Checks and reattaches on both page creation and updates.
 * Helps with deleting unattached images.
 * Add to theme functions file.
 *
 * @author Created by Guardian Digital Group <https://guardiandigitalgroup.com>
 * @param int     $post_id The ID of the page being saved/updated.
 * @param WP_Post $post    The page object.
 * @param bool    $update  Whether this is an update (true) or a new page (false).
 */
function auto_attach_featured_image_to_pages( $post_id, $post, $update ) {
    // Skip if this is an autosave
    if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
        return;
    }

    // Only run for pages
    if ( 'page' !== $post->post_type ) {
        return;
    }

    // Skip if user lacks permission to edit the page
    if ( ! current_user_can( 'edit_page', $post_id ) ) {
        return;
    }

    // Check if a featured image is set for the page
    if ( ! has_post_thumbnail( $post_id ) ) {
        return;
    }

    $featured_image_id = get_post_thumbnail_id( $post_id );
    if ( ! $featured_image_id ) {
        return;
    }

    // Get the current post_parent of the featured image
    $attachment = get_post( $featured_image_id );
    if ( ! $attachment || 'attachment' !== $attachment->post_type ) {
        return;
    }

    $current_parent = (int) $attachment->post_parent;

    // Skip if the image is already correctly attached to this page
    if ( $current_parent === $post_id ) {
        return;
    }

    // Allow developers to filter whether to reattach the image
    $should_reattach = apply_filters(
        'auto_attach_featured_image_should_reattach',
        ( $current_parent === 0 || $current_parent !== $post_id ),
        $post_id,
        $featured_image_id,
        $current_parent
    );

    if ( ! $should_reattach ) {
        return;
    }

    // Prevent infinite loops by removing the hook temporarily
    remove_action( 'save_post', 'auto_attach_featured_image_to_pages', 10 );

    // Update the post_parent of the featured image
    $update_result = wp_update_post(
        array(
            'ID'          => $featured_image_id,
            'post_parent' => $post_id,
        ),
        true // Return WP_Error on failure
    );

    // Reattach the hook
    add_action( 'save_post', 'auto_attach_featured_image_to_pages', 10, 3 );

    // Log errors if the update fails (optional, can be removed if not needed)
    if ( is_wp_error( $update_result ) ) {
        error_log( 'Failed to attach featured image to page: ' . $update_result->get_error_message() );
    }
}

// Hook into save_post to attach featured image when a page is saved or updated
add_action( 'save_post', 'auto_attach_featured_image_to_pages', 10, 3 );
